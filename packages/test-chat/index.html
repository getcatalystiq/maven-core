<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Maven Chat Test</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; display: flex; justify-content: center; align-items: center; }
    .container { width: 100%; max-width: 600px; padding: 20px; }
    h1 { text-align: center; margin-bottom: 20px; color: #7c3aed; }
    .login-form, .chat-container { background: #16213e; border-radius: 12px; padding: 24px; }
    .form-group { margin-bottom: 16px; }
    label { display: block; margin-bottom: 6px; font-size: 14px; color: #aaa; }
    input { width: 100%; padding: 12px; border: 1px solid #333; border-radius: 8px; background: #0f0f23; color: #eee; font-size: 16px; }
    input:focus { outline: none; border-color: #7c3aed; }
    button { width: 100%; padding: 12px; background: #7c3aed; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
    button:hover { background: #6d28d9; }
    button:disabled { background: #444; cursor: not-allowed; }
    .error { color: #f87171; font-size: 14px; margin-top: 8px; }
    .hidden { display: none; }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .header h2 { font-size: 18px; }
    .logout-btn { padding: 8px 16px; width: auto; font-size: 14px; background: #374151; }
    .session-id { font-size: 12px; color: #666; margin-bottom: 12px; }
    .messages { height: 400px; overflow-y: auto; border: 1px solid #333; border-radius: 8px; padding: 16px; margin-bottom: 16px; background: #0f0f23; }
    .message { margin-bottom: 12px; padding: 10px 14px; border-radius: 8px; max-width: 85%; }
    .message.user { background: #7c3aed; margin-left: auto; }
    .message.assistant { background: #374151; }
    .message.error { background: #7f1d1d; }
    .input-row { display: flex; gap: 12px; }
    .input-row input { flex: 1; }
    .input-row button { width: auto; padding: 12px 24px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Maven Chat Test</h1>

    <!-- Login Form -->
    <div id="login-section" class="login-form">
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="email" value="dev@example.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="password" value="">
      </div>
      <div class="form-group">
        <label>Tenant ID (optional)</label>
        <input type="text" id="tenant-id" value="" placeholder="Leave blank for super-admin">
      </div>
      <button id="login-btn">Login</button>
      <div id="login-error" class="error hidden"></div>
    </div>

    <!-- Chat Interface -->
    <div id="chat-section" class="chat-container hidden">
      <div class="header">
        <h2>Chat</h2>
        <button id="logout-btn" class="logout-btn">Logout</button>
      </div>
      <div id="session-id" class="session-id"></div>
      <div id="messages" class="messages"></div>
      <div class="input-row">
        <input type="text" id="message-input" placeholder="Type a message...">
        <button id="send-btn">Send</button>
      </div>
    </div>
  </div>

  <script>
    const CONTROL_PLANE_URL = 'http://localhost:8787';
    const TENANT_WORKER_URL = 'http://localhost:8788';

    let accessToken = null;
    let sessionId = null;

    const $ = id => document.getElementById(id);

    // Login
    $('login-btn').addEventListener('click', async () => {
      const email = $('email').value;
      const password = $('password').value;
      const tenantId = $('tenant-id').value.trim();
      const errorEl = $('login-error');

      errorEl.classList.add('hidden');
      $('login-btn').disabled = true;
      $('login-btn').textContent = 'Logging in...';

      try {
        const headers = { 'Content-Type': 'application/json' };
        if (tenantId) {
          headers['X-Tenant-Id'] = tenantId;
        }
        const res = await fetch(`${CONTROL_PLANE_URL}/auth/login`, {
          method: 'POST',
          headers,
          body: JSON.stringify({ email, password })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Login failed');
        }

        accessToken = data.access_token;
        sessionId = crypto.randomUUID();

        $('login-section').classList.add('hidden');
        $('chat-section').classList.remove('hidden');
        $('session-id').textContent = `Session: ${sessionId}`;
        $('message-input').focus();
      } catch (err) {
        errorEl.textContent = err.message;
        errorEl.classList.remove('hidden');
      } finally {
        $('login-btn').disabled = false;
        $('login-btn').textContent = 'Login';
      }
    });

    // Logout
    $('logout-btn').addEventListener('click', () => {
      accessToken = null;
      sessionId = null;
      $('messages').innerHTML = '';
      $('chat-section').classList.add('hidden');
      $('login-section').classList.remove('hidden');
    });

    // Send message
    async function sendMessage() {
      const input = $('message-input');
      const message = input.value.trim();
      if (!message) return;

      input.value = '';
      $('send-btn').disabled = true;

      addMessage(message, 'user');

      try {
        const res = await fetch(`${TENANT_WORKER_URL}/chat/stream`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({ message, sessionId })
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({ error: 'Request failed' }));
          throw new Error(err.error || `HTTP ${res.status}`);
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let assistantMsg = '';
        let msgEl = null;
        let buffer = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          // Keep the last (potentially incomplete) line in the buffer
          buffer = lines.pop() || '';

          for (const line of lines) {
            if (!line.trim()) continue;
            try {
              const event = JSON.parse(line);
              console.log('Event:', event.type, line.substring(0, 120));

              if (event.type === 'start') {
                sessionId = event.sessionId || sessionId;
                $('session-id').textContent = `Session: ${sessionId}`;
              } else if (event.type === 'content') {
                // Direct content event from agent
                console.log('Content text:', event.text);
                if (event.text) {
                  if (!msgEl) {
                    msgEl = addMessage('', 'assistant');
                  }
                  assistantMsg = event.text; // Use full text, not append
                  msgEl.textContent = assistantMsg;
                  scrollMessages();
                }
              } else if (event.type === 'stream' && event.event) {
                // Stream event with nested delta (real-time streaming)
                const inner = event.event;
                if (inner.type === 'content_block_delta' && inner.delta?.text) {
                  if (!msgEl) {
                    msgEl = addMessage('', 'assistant');
                  }
                  assistantMsg += inner.delta.text;
                  msgEl.textContent = assistantMsg;
                  scrollMessages();
                }
              } else if (event.type === 'error') {
                addMessage(`Error: ${event.error || event.message}`, 'error');
              }
            } catch (e) {
              console.log('Parse error:', line, e);
            }
          }
        }

        if (!msgEl && assistantMsg === '') {
          addMessage('(No response)', 'assistant');
        }
      } catch (err) {
        addMessage(`Error: ${err.message}`, 'error');
      } finally {
        $('send-btn').disabled = false;
        input.focus();
      }
    }

    function addMessage(text, type) {
      const el = document.createElement('div');
      el.className = `message ${type}`;
      el.textContent = text;
      $('messages').appendChild(el);
      scrollMessages();
      return el;
    }

    function scrollMessages() {
      const msgs = $('messages');
      msgs.scrollTop = msgs.scrollHeight;
    }

    $('send-btn').addEventListener('click', sendMessage);
    $('message-input').addEventListener('keydown', e => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Allow Enter to submit login
    $('password').addEventListener('keydown', e => {
      if (e.key === 'Enter') $('login-btn').click();
    });
  </script>
</body>
</html>
